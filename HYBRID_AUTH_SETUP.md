# Hybrid Authentication Setup

The system now supports **both Supabase and PostgreSQL database authentication** simultaneously for testing purposes.

## How It Works

### Login Flow

1. **Frontend tries Supabase first** - If user has Supabase account, login succeeds
2. **Falls back to backend `/auth/login`** - If Supabase fails, tries PostgreSQL database authentication
3. **Backend endpoint tries both**:
   - First attempts Supabase authentication
   - If that fails, checks PostgreSQL database for user with `password_hash`

### Authentication Methods

#### 1. Supabase Authentication
- Users created via Supabase (OAuth or email/password sign-up)
- Token: Supabase access token
- Stored in: Supabase Auth system

#### 2. Database Authentication  
- Users with `password_hash` in PostgreSQL database
- Token: JWT token (generated by backend)
- Stored in: PostgreSQL `users` table

## Backend Endpoint

**POST `/auth/login`**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "access_token": "token_here",
  "token_type": "bearer",
  "user_id": "uuid",
  "user_name": "User Name",
  "user_email": "user@example.com",
  "user_role": "USER",
  "auth_method": "supabase" | "database"
}
```

## Testing Your User

For `harsh3@example.com` with password hash in database:

1. **Try login via frontend** - It will automatically try both methods
2. **Or use the API directly:**
```bash
curl -X POST "http://localhost:8000/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "harsh3@example.com", "password": "your_password"}'
```

## Token Validation

The backend `get_current_user()` dependency now supports both:
- **Supabase tokens** - Validated via Supabase API
- **JWT tokens** - Validated via JWT decoding (for database users)

## Environment Variables

Make sure these are set in your `.env`:

**For Supabase Auth:**
```
DISABLE_AUTH=false
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key
```

**For JWT Tokens (Database Auth):**
```
SECRET_KEY=your_secret_key_here  # Change this in production!
```

## Notes

- Users can login with **either** method
- Supabase users don't need `password_hash` in database
- Database users need `password_hash` set in database
- Both methods work simultaneously - no conflicts
- Frontend automatically tries both methods in sequence

## Migration Path

1. **Current users with `password_hash`** → Can login via database auth
2. **New users** → Should use Supabase (OAuth or sign-up)
3. **Gradual migration** → Users can be moved to Supabase over time
